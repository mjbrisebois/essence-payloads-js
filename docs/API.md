[back to README.md](../README.md)

# API Reference

Examples assume the module is loaded like this
```javascript
const { Translator, Package } = require("@whi/essence");
```


## `new Translator( expected_kinds = [], options = {} )`
This is a class so that you can have multiple instances of Essence with different settings.

- `expected_kinds` - (*optional*) list of allowed error kinds; defaults to allow any kind
- `options` - (*optional*) configurable values.  `null` or `undefined` will be interrpreted as empty config
  - `rm_stack_lines` - (*optional*) the number of useless traceback lines to remove; defaults to 0

#### Example usage
```javascript
const Interpreter = new Translator([ "UserError" ], {
    "rm_stack_lines": 1,
});
```

#### Why remove stack lines?
When no `stack` is supplied in a parsed message, a `traceback` is generated by this library.  Calls
to this library will typeically be burried under a few layers of generic message handling.  Those
extra stack lines just get in the way of the actually source where the error was raised.
`rm_stack_lines` will remove the given number of lines so that the top traceback line is the
actually place where the error occurred.


### `<Translator>.parse( input )`
This method will parse a valid Essence package into the appropriate `Package` instance.

- `input` - can be JSON string or object

Returns an instance of `Package`.

#### Example

Success package
```javascript
const pack = Interpreter.parse({
    "type": "success",
    "payload": true,
});
// or
const pack = Interpreter.parse( JSON.stringify({
    "type": "success",
    "payload": true,
}) );

pack.value();
// true
```

Failure package
```javascript
const pack = Interpreter.parse({
    "kind": "UserError",
    "error": "TypeError",
    "message": "You broke it",
});

pack.value();
// TypeError: You broke it
//     at ...
```


### `<Translator>.create( ...args )`
A shortcut to create a new `Package` by forwarding arguments and using `this` as the `Translator`
instance.

#### Example
```javascript
<Translator>.create( ...args )
// same as
new Package( <Translator>, ...args );
```

Returns the newly created package instance.


### `<Translator>.createFromError( kind, error )`
A shortcut for generating failure packages out of any given instance of the `Error` class.

- `kind` - a string value used as `kind` in the payload
- `error` - an `Error` instance used to determine the other payload values (`error`, `message`, `stack`)

Returns the newly created package instance.

#### Example usage
```javascript
const err_pack = Translator.createFromError( "UserError", new TypeError("You broke it") );
```



## `new Package( <Translator>, payload, options = {}, metadata )`
Create a new instance of `Package`.

- `payload` - any value that can be converted to JSON
- `options` - (*optional*) configurable values.  `null` or `undefined` will be interrpreted as empty config
  - `type` - (*optional*) can be [`success`, `failure`]; defaults to `success`
- `metadata` - (*optional*) an object of key/value pairs that will be set as the package's metadata


#### Example usage
Success package
```javascript
const pack = new Package( <Translator>, "I am a werewolf", null, {
    "constraints": [
        "when there is a full moon",
        "when it is night time",
    ],
});
```

Failure package
```javascript
const err_pack = new Package( <Translator>, {
    "kind": "UserError"
    "error": "TypeError",
    "message": "You broke it",
    "stack": [
        "TypeError: You broke it",
        "    at ...",
   ],
}, {
    "type": "failure"
});
```


### `<Package>.metadata( key, value? )`
A method for getting and setting the package's metadata values.

- `key` - if `value` is present, get this metadata key; otherwise, set this key to `value`
- `value` - (*optional*) any value that can be converted to JSON.
  - a value of `undefined` will remove `key` from the package's metadata.

Returns the metadata value for the given `key`.  If the `key` was removed in this operation then the
deleted value is returned.


### `<Package>.value()`
Returns the translated payload value.

#### Example usage

Success example
```javascript
pack.value()
// 'I am a werewolf'
```

Failure example
```javascript
err_pack.value()
// TypeError: You broke it
//     at ...
```


### `<Package>.toJSON()`
Returns a JSON serializable object of the package.

#### Example usage

Success example
```javascript
pack.toJSON()
// {
//     type: 'success',
//     payload: 'I am a werewolf',
//     metadata: {
//         constraints: [ 'when there is a full moon', 'when it is night time' ]
//     }
// }
```

Failure example
```javascript
err_pack.toJSON()
// {
//     type: 'failure',
//     payload: {
//         kind: 'UserError',
//         error: 'TypeError',
//         message: 'You broke it',
//         stack: [
//             "TypeError: You broke it",
//             "    at ..."
//         ]
//     }
// }
```


### `<Package>.toString()`
Returns a JSON string of the package.

#### Example usage

Success package
```javascript
pack.toString()
// '{"type":"success","payload":"I am a werewolf","metadata":{"constraints":["when there is a full moon","when it is night time"]}}'
```

Failure package
```javascript
err_pack.toString()
// '{"type":"failure","payload":{"kind":"UserError","error":"TypeError","message":"You broke it","stack":["TypeError: You broke it","    at ..."]}}'
```
